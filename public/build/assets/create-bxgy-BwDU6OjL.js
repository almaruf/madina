function f(){const t=localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token");return t?{Authorization:`Bearer ${t}`}:{}}let p=[],w=[],r=[],c=[],u="buy",m=[];async function E(){try{const[t,n]=await Promise.all([axios.get("/api/admin/products",{headers:f()}),axios.get("/api/admin/categories",{headers:f()})]);p=t.data.data||t.data,w=n.data.data||n.data;const e=document.getElementById("product-category-filter");w.forEach(o=>{const a=document.createElement("option");a.value=o.id,a.textContent=o.name,e.appendChild(a)})}catch(t){console.error("Error loading data:",t),window.toast.error("Failed to load products and categories")}}function B(t){document.querySelectorAll('input[name="offer_type"]').forEach(n=>{n.checked=n.value===t}),_()}function _(){const t=document.querySelector('input[name="offer_type"]:checked').value,n=document.getElementById("discount-field");t==="bxgy_discount"?(n.classList.remove("hidden"),document.getElementById("get_discount_percentage").required=!0):(n.classList.add("hidden"),document.getElementById("get_discount_percentage").required=!1)}function I(){const t=document.getElementById("same_as_buy").checked,n=document.getElementById("get-product-selection");t?(n.style.opacity="0.5",n.style.pointerEvents="none",c=[...r],g("get")):(n.style.opacity="1",n.style.pointerEvents="auto")}function P(t){u=t;const n=document.getElementById("product-modal"),e=document.getElementById("modal-title"),o=document.getElementById("modal-subtitle");t==="buy"?(e.textContent="Select Products to Buy",o.textContent="Choose which products customers must purchase"):(e.textContent="Select Products to Get",o.textContent="Choose which products customers will receive"),n.classList.remove("hidden"),b(),y()}function v(){document.getElementById("product-modal").classList.add("hidden")}function b(){const t=document.getElementById("product-search").value.toLowerCase(),n=document.getElementById("product-category-filter").value;m=p.filter(e=>{const o=!t||e.name.toLowerCase().includes(t)||e.description&&e.description.toLowerCase().includes(t),a=!n||e.categories&&e.categories.some(d=>d.id==n);return o&&a}),h()}function h(){const t=document.getElementById("products-list"),n=u==="buy"?r.map(e=>e.id):c.map(e=>e.id);if(m.length===0){t.innerHTML='<p class="text-center text-gray-500 py-8">No products found</p>';return}t.innerHTML=m.map(e=>{var d,i,l;const o=n.includes(e.id),a=((d=e.default_variation)==null?void 0:d.price)||((l=(i=e.variations)==null?void 0:i[0])==null?void 0:l.price);return`
            <label class="flex items-center gap-4 p-3 rounded-lg border-2 cursor-pointer hover:bg-gray-50 transition ${o?"border-green-500 bg-green-50":"border-gray-200"}">
                <input type="checkbox" 
                    class="w-5 h-5" 
                    ${o?"checked":""}
                    onchange="window.toggleProductSelection(${e.id})"
                    data-product-id="${e.id}">
                
                ${e.primary_image?`<img src="${e.primary_image.url}" class="w-16 h-16 object-cover rounded">`:'<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                
                <div class="flex-1">
                    <p class="font-medium text-gray-900">${e.name}</p>
                    <p class="text-sm text-gray-600">${a?"£"+a:"N/A"}</p>
                    ${e.categories&&e.categories.length>0?`<p class="text-xs text-gray-500 mt-1">${e.categories.map(s=>s.name).join(", ")}</p>`:""}
                </div>
            </label>
        `}).join("")}function S(t){const n=p.find(a=>a.id===t);if(!n)return;const e=u==="buy"?r:c,o=e.findIndex(a=>a.id===t);o>-1?e.splice(o,1):e.push(n),y()}function C(){const t=u==="buy"?r:c;m.forEach(n=>{t.find(e=>e.id===n.id)||t.push(n)}),h(),y()}function $(){u==="buy"?r=[]:c=[],h(),y()}function y(){const t=u==="buy"?r.length:c.length;document.getElementById("selection-count").textContent=t}function k(){g(u),v(),document.getElementById("same_as_buy").checked&&u==="buy"&&(c=[...r],g("get"))}function g(t){const n=t==="buy"?r:c,e=document.getElementById(`${t}-products-display`);if(n.length===0){e.innerHTML='<p class="text-gray-500">No products selected. Click "Add" to select products.</p>';return}e.innerHTML=`
        <div class="text-sm font-semibold text-gray-700 mb-2">${n.length} product(s) selected</div>
        <div class="grid md:grid-cols-2 gap-3">
            ${n.map(o=>{var d,i,l;const a=((d=o.default_variation)==null?void 0:d.price)||((l=(i=o.variations)==null?void 0:i[0])==null?void 0:l.price);return`
                    <div class="flex items-center gap-3 p-3 border rounded-lg bg-gray-50">
                        ${o.primary_image?`<img src="${o.primary_image.url}" class="w-12 h-12 object-cover rounded">`:'<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                        
                        <div class="flex-1">
                            <p class="font-medium text-sm">${o.name}</p>
                            <p class="text-xs text-gray-600">${a?"£"+a:"N/A"}</p>
                        </div>
                        
                        <button type="button" onclick="window.removeProduct('${t}', ${o.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `}).join("")}
        </div>
    `}function A(t,n){t==="buy"?r=r.filter(e=>e.id!==n):c=c.filter(e=>e.id!==n),g(t)}async function L(t){var a,d,i,l;if(t.preventDefault(),r.length===0){window.toast.error('Please select at least one "Buy" product');return}const n=document.getElementById("same_as_buy").checked;if(!n&&c.length===0){window.toast.error('Please select at least one "Get" product or check "Same as Buy products"');return}const e=document.querySelector('input[name="offer_type"]:checked').value,o={name:document.getElementById("name").value,description:document.getElementById("description").value,type:e,buy_quantity:parseInt(document.getElementById("buy_quantity").value),get_quantity:parseInt(document.getElementById("get_quantity").value),badge_text:document.getElementById("badge_text").value,badge_color:document.getElementById("badge_color").value,starts_at:document.getElementById("starts_at").value||null,ends_at:document.getElementById("ends_at").value||null,max_uses_per_customer:document.getElementById("max_uses_per_customer").value||null,total_usage_limit:document.getElementById("total_usage_limit").value||null,is_active:document.getElementById("is_active").checked,buy_product_ids:r.map(s=>s.id),get_product_ids:n?r.map(s=>s.id):c.map(s=>s.id)};e==="bxgy_discount"&&(o.get_discount_percentage=parseFloat(document.getElementById("get_discount_percentage").value));try{await axios.post("/api/admin/offers/bxgy",o,{headers:f()}),window.toast.success("Offer created successfully!"),window.location.href="/admin/offers"}catch(s){if(console.error("Error creating offer:",s),(d=(a=s.response)==null?void 0:a.data)!=null&&d.errors){const x=Object.values(s.response.data.errors).flat();window.toast.error(`Validation errors:
`+x.join(`
`))}else window.toast.error("Failed to create offer: "+(((l=(i=s.response)==null?void 0:i.data)==null?void 0:l.message)||s.message))}}window.selectOfferType=B;window.handleOfferTypeChange=_;window.handleSameAsBuyChange=I;window.openProductModal=P;window.closeProductModal=v;window.searchProducts=b;window.toggleProductSelection=S;window.selectAllVisibleProducts=C;window.clearCurrentSelection=$;window.confirmProductSelection=k;window.removeProduct=A;window.handleSubmit=L;document.addEventListener("DOMContentLoaded",()=>{E()});
