function g(){const e=localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token");return e?{Authorization:`Bearer ${e}`}:{}}const _=new URLSearchParams(window.location.search).get("id");let a=null,h=[],b=[],d=[],c=[],u="buy",f=[];async function x(){var e,o;try{const[t,n,s]=await Promise.all([axios.get(`/api/admin/offers/${_}`,{headers:g()}),axios.get("/api/admin/products?per_page=1000",{headers:g()}),axios.get("/api/admin/categories",{headers:g()})]);a=t.data,h=n.data.data||n.data,b=s.data.data||s.data,d=a.buy_products||a.products||[],c=a.get_products||a.products||[],P(),S(),document.getElementById("loading-state").classList.add("hidden"),document.getElementById("form-container").classList.remove("hidden")}catch(t){console.error("Error loading offer:",t),alert("Failed to load offer: "+(((o=(e=t.response)==null?void 0:e.data)==null?void 0:o.message)||t.message)),window.location.href="/admin/offers"}}function P(){document.getElementById("name").value=a.name||"",document.getElementById("description").value=a.description||"",document.getElementById("buy_quantity").value=a.buy_quantity||2,document.getElementById("get_quantity").value=a.get_quantity||1,document.getElementById("badge_text").value=a.badge_text||"",document.getElementById("badge_color").value=a.badge_color||"#DC2626",document.getElementById("max_uses_per_customer").value=a.max_uses_per_customer||"",document.getElementById("total_usage_limit").value=a.total_usage_limit||"",document.getElementById("is_active").checked=a.is_active;const e=a.type==="bxgy_free"?"Buy X Get Y Free":"Buy X Get Y at Discount";document.getElementById("offer_type_display").value=e,a.type==="bxgy_discount"&&(document.getElementById("discount-field").classList.remove("hidden"),document.getElementById("get_discount_percentage").value=a.get_discount_percentage||""),a.starts_at&&(document.getElementById("starts_at").value=new Date(a.starts_at).toISOString().slice(0,16)),a.ends_at&&(document.getElementById("ends_at").value=new Date(a.ends_at).toISOString().slice(0,16));const o=d.map(n=>n.id).sort().join(","),t=c.map(n=>n.id).sort().join(",");o===t&&o!==""&&(document.getElementById("same_as_buy").checked=!0,B()),m("buy"),m("get")}function S(){const e=document.getElementById("product-category-filter");b.forEach(o=>{const t=document.createElement("option");t.value=o.id,t.textContent=o.name,e.appendChild(t)})}function B(){const e=document.getElementById("same_as_buy").checked,o=document.getElementById("get-product-selection");e?(o.style.opacity="0.5",o.style.pointerEvents="none",c=[...d],m("get")):(o.style.opacity="1",o.style.pointerEvents="auto")}function C(e){u=e;const o=document.getElementById("product-modal"),t=document.getElementById("modal-title"),n=document.getElementById("modal-subtitle");e==="buy"?(t.textContent="Select Products to Buy",n.textContent="Choose which products customers must purchase"):(t.textContent="Select Products to Get",n.textContent="Choose which products customers will receive"),o.classList.remove("hidden"),E(),p()}function w(){document.getElementById("product-modal").classList.add("hidden")}function E(){const e=document.getElementById("product-search").value.toLowerCase(),o=document.getElementById("product-category-filter").value;f=h.filter(t=>{const n=!e||t.name.toLowerCase().includes(e)||t.description&&t.description.toLowerCase().includes(e),s=!o||t.categories&&t.categories.some(i=>i.id==o);return n&&s}),v()}function v(){const e=document.getElementById("products-list"),t=(u==="buy"?d:c).map(n=>n.id);if(f.length===0){e.innerHTML='<p class="text-center text-gray-500 py-8">No products found</p>';return}e.innerHTML=f.map(n=>{var l,r,y;const s=t.includes(n.id),i=((l=n.default_variation)==null?void 0:l.price)||((y=(r=n.variations)==null?void 0:r[0])==null?void 0:y.price);return`
            <label class="flex items-center gap-4 p-3 rounded-lg border-2 cursor-pointer hover:bg-gray-50 transition ${s?"border-green-500 bg-green-50":"border-gray-200"}">
                <input type="checkbox" 
                    class="w-5 h-5" 
                    ${s?"checked":""}
                    onchange="window.toggleProductSelection(${n.id})"
                    data-product-id="${n.id}">
                
                ${n.primary_image?`<img src="${n.primary_image.url}" class="w-16 h-16 object-cover rounded">`:'<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                
                <div class="flex-1">
                    <p class="font-medium text-gray-900">${n.name}</p>
                    <p class="text-sm text-gray-600">${i?"£"+i:"N/A"}</p>
                    ${n.categories&&n.categories.length>0?`<p class="text-xs text-gray-500 mt-1">${n.categories.map(I=>I.name).join(", ")}</p>`:""}
                </div>
            </label>
        `}).join("")}function $(e){const o=h.find(s=>s.id===e);if(!o)return;const t=u==="buy"?d:c,n=t.findIndex(s=>s.id===e);n>-1?t.splice(n,1):t.push(o),p()}function L(){const e=u==="buy"?d:c;f.forEach(o=>{e.find(t=>t.id===o.id)||e.push(o)}),v(),p()}function k(){u==="buy"?d=[]:c=[],v(),p()}function p(){const e=u==="buy"?d.length:c.length;document.getElementById("selection-count").textContent=e}function A(){m(u),w(),document.getElementById("same_as_buy").checked&&u==="buy"&&(c=[...d],m("get"))}function m(e){const o=e==="buy"?d:c,t=document.getElementById(`${e}-products-display`);if(o.length===0){t.innerHTML='<p class="text-gray-500">No products selected. Click "Manage" to select products.</p>';return}t.innerHTML=`
        <div class="text-sm font-semibold text-gray-700 mb-2">${o.length} product(s) selected</div>
        <div class="grid md:grid-cols-2 gap-3">
            ${o.map(n=>{var i,l,r;const s=((i=n.default_variation)==null?void 0:i.price)||((r=(l=n.variations)==null?void 0:l[0])==null?void 0:r.price);return`
                    <div class="flex items-center gap-3 p-3 border rounded-lg bg-gray-50">
                        ${n.primary_image?`<img src="${n.primary_image.url}" class="w-12 h-12 object-cover rounded">`:'<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i class="fas fa-image text-gray-400"></i></div>'}
                        
                        <div class="flex-1">
                            <p class="font-medium text-sm">${n.name}</p>
                            <p class="text-xs text-gray-600">${s?"£"+s:"N/A"}</p>
                        </div>
                        
                        <button type="button" onclick="window.removeProduct('${e}', ${n.id})" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `}).join("")}
        </div>
    `}function j(e,o){e==="buy"?d=d.filter(t=>t.id!==o):c=c.filter(t=>t.id!==o),m(e)}async function M(e){var n,s,i,l;if(e.preventDefault(),d.length===0){alert('Please select at least one "Buy" product');return}const o=document.getElementById("same_as_buy").checked;if(!o&&c.length===0){alert('Please select at least one "Get" product or check "Same as Buy products"');return}const t={name:document.getElementById("name").value,description:document.getElementById("description").value,buy_quantity:parseInt(document.getElementById("buy_quantity").value),get_quantity:parseInt(document.getElementById("get_quantity").value),badge_text:document.getElementById("badge_text").value,badge_color:document.getElementById("badge_color").value,starts_at:document.getElementById("starts_at").value||null,ends_at:document.getElementById("ends_at").value||null,max_uses_per_customer:document.getElementById("max_uses_per_customer").value||null,total_usage_limit:document.getElementById("total_usage_limit").value||null,is_active:document.getElementById("is_active").checked,buy_product_ids:d.map(r=>r.id),get_product_ids:o?d.map(r=>r.id):c.map(r=>r.id)};a.type==="bxgy_discount"&&(t.get_discount_percentage=parseFloat(document.getElementById("get_discount_percentage").value));try{await axios.put(`/api/admin/offers/${_}`,t,{headers:g()}),alert("Offer updated successfully!"),window.location.href="/admin/offers"}catch(r){if(console.error("Error updating offer:",r),(s=(n=r.response)==null?void 0:n.data)!=null&&s.errors){const y=Object.values(r.response.data.errors).flat();alert(`Validation errors:
`+y.join(`
`))}else alert("Failed to update offer: "+(((l=(i=r.response)==null?void 0:i.data)==null?void 0:l.message)||r.message))}}async function D(){if(confirm("Are you sure you want to delete this offer? This action cannot be undone."))try{await axios.delete(`/api/admin/offers/${_}`,{headers:g()}),alert("Offer deleted successfully"),window.location.href="/admin/offers"}catch(e){console.error("Error deleting offer:",e),alert("Failed to delete offer")}}window.handleSameAsBuyChange=B;window.openProductModal=C;window.closeProductModal=w;window.searchProducts=E;window.toggleProductSelection=$;window.selectAllVisibleProducts=L;window.clearCurrentSelection=k;window.confirmProductSelection=A;window.removeProduct=j;window.handleSubmit=M;window.deleteOffer=D;document.addEventListener("DOMContentLoaded",()=>{x()});
