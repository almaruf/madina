function l(){const e=localStorage.getItem("auth_token")||sessionStorage.getItem("auth_token");return e?{Authorization:`Bearer ${e}`}:{}}const f=new URLSearchParams(window.location.search).get("id");let c=null,i=[],h=[],s=[];async function x(){var e,n;try{const[t,o]=await Promise.all([axios.get(`/api/admin/offers/${f}`,{headers:l()}),axios.get("/api/admin/categories",{headers:l()})]);c=t.data,h=o.data.data||o.data,s=(c.products||[]).map(a=>a.id),E(),I(),document.getElementById("loading-state").classList.add("hidden"),document.getElementById("form-container").classList.remove("hidden")}catch(t){console.error("Error loading offer:",t),window.toast.error("Failed to load offer: "+(((n=(e=t.response)==null?void 0:e.data)==null?void 0:n.message)||t.message))}}function E(){const e=(t,o)=>{const a=document.getElementById(t);a&&(a.value=o||"")},n=(t,o)=>{const a=document.getElementById(t);a&&(a.checked=o)};if(e("name",c.name),e("description",c.description),e("badge_text",c.badge_text),e("badge_color",c.badge_color||"#DC2626"),e("discount_value",c.discount_value),e("min_purchase_amount",c.min_purchase_amount),e("max_uses_per_customer",c.max_uses_per_customer),e("total_usage_limit",c.total_usage_limit),n("is_active",c.is_active),c.starts_at&&e("starts_at",new Date(c.starts_at).toISOString().slice(0,16)),c.ends_at&&e("ends_at",new Date(c.ends_at).toISOString().slice(0,16)),c.scope){const t=document.querySelector(`input[name="product-scope"][value="${c.scope}"]`);if(t&&(t.checked=!0,c.scope==="category"&&c.category_id)){const o=document.getElementById("selected-category");o&&(o.value=c.category_id)}}else{const t=document.querySelector('input[name="product-scope"][value="all"]');t&&(t.checked=!0)}v(),g()}function I(){const e=document.getElementById("selected-category"),n=document.getElementById("product-category-filter");h.forEach(t=>{const o=document.createElement("option");o.value=t.id,o.textContent=t.name,e.appendChild(o);const a=document.createElement("option");a.value=t.id,a.textContent=t.name,n.appendChild(a)})}function v(){const e=document.querySelector('input[name="product-scope"]:checked');if(!e)return;const n=e.value,t=document.getElementById("category-selection"),o=document.getElementById("product-selection");t&&t.classList.add("hidden"),o&&o.classList.add("hidden"),n==="category"&&t?t.classList.remove("hidden"):n==="selected"&&o&&o.classList.remove("hidden")}async function b(){try{const e=await axios.get("/api/admin/products?per_page=1000",{headers:l()});i=e.data.data||e.data,w(i),document.getElementById("product-modal").classList.remove("hidden")}catch(e){console.error("Error loading products:",e),window.toast.error("Failed to load products")}}function _(){document.getElementById("product-modal").classList.add("hidden")}function w(e){const n=document.getElementById("products-list");n.innerHTML=e.map(t=>{var u,p,y;const o=((u=t.primary_image)==null?void 0:u.url)||null,a=((p=t.variations)==null?void 0:p.find(m=>m.is_default))||((y=t.variations)==null?void 0:y[0]),r=a!=null&&a.price?`Â£${parseFloat(a.price).toFixed(2)}`:"No price",d=(t.categories||[]).map(m=>`<span class="px-2 py-0.5 bg-gray-100 text-gray-600 rounded-full text-xs">${m.name}</span>`).join("");return`
        <label class="flex items-start gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 mb-2">
            <input type="checkbox" value="${t.id}" class="product-checkbox mt-1"
                ${s.includes(t.id)?"checked":""}>
            <div class="w-14 h-14 flex-shrink-0 bg-gray-100 rounded-lg overflow-hidden">
                ${o?`<img src="${o}" alt="${t.name}" class="w-full h-full object-cover">`:'<div class="w-full h-full flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>'}
            </div>
            <div class="flex-1 min-w-0">
                <div class="flex items-center justify-between gap-2">
                    <div class="font-semibold truncate">${t.name}</div>
                    <div class="text-sm font-semibold text-green-600">${r}</div>
                </div>
                <div class="text-xs text-gray-500">SKU: ${t.sku||"N/A"}</div>
                ${d?`<div class="flex flex-wrap gap-1 mt-2">${d}</div>`:""}
            </div>
        </label>
        `}).join("")}function B(){const e=document.getElementById("product-search").value.toLowerCase(),n=document.getElementById("product-category-filter").value,t=i.filter(o=>{var d;const a=o.name.toLowerCase().includes(e)||o.sku&&o.sku.toLowerCase().includes(e),r=!n||((d=o.categories)==null?void 0:d.some(u=>u.id==n));return a&&r});w(t)}function S(){s=Array.from(document.querySelectorAll(".product-checkbox:checked")).map(e=>parseInt(e.value)),g(),_()}function g(){const e=document.getElementById("selected-products-display"),t=(i.length>0?i:(c==null?void 0:c.products)||[]).filter(o=>s.includes(o.id));e.innerHTML=t.length>0?t.map(o=>`
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                <span class="text-sm">${o.name}</span>
                <button type="button" onclick="window.removeProduct(${o.id})" class="text-red-600 hover:text-red-700">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `).join(""):'<p class="text-gray-500 text-sm">No products selected</p>'}function P(e){s=s.filter(n=>n!==e),g()}function k(){s=[],document.querySelectorAll(".product-checkbox").forEach(e=>e.checked=!1)}async function $(e){var o,a;e.preventDefault();const n=document.querySelector('input[name="product-scope"]:checked').value;if(n==="selected"&&s.length===0){window.toast.error("Please select at least one product");return}if(n==="category"&&!document.getElementById("selected-category").value){window.toast.error("Please select a category");return}const t={name:document.getElementById("name").value,description:document.getElementById("description").value||null,badge_text:document.getElementById("badge_text").value||null,badge_color:document.getElementById("badge_color").value,discount_value:document.getElementById("discount_value").value,min_purchase_amount:document.getElementById("min_purchase_amount").value||null,max_uses_per_customer:document.getElementById("max_uses_per_customer").value||null,total_usage_limit:document.getElementById("total_usage_limit").value||null,starts_at:document.getElementById("starts_at").value||null,ends_at:document.getElementById("ends_at").value||null,is_active:document.getElementById("is_active").checked,scope:n,category_id:n==="category"?document.getElementById("selected-category").value:null,product_ids:n==="selected"?s:[]};try{await axios.put(`/api/admin/offers/${f}`,t,{headers:l()}),window.toast.success("Offer updated successfully"),setTimeout(()=>window.location.href="/admin/offers",1500)}catch(r){console.error("Error updating offer:",r);const d=((a=(o=r.response)==null?void 0:o.data)==null?void 0:a.message)||"Failed to update offer";window.toast.error(d)}}async function L(){if(confirm("Are you sure you want to delete this offer? This action cannot be undone."))try{await axios.delete(`/api/admin/offers/${f}`,{headers:l()}),window.toast.success("Offer deleted successfully"),setTimeout(()=>window.location.href="/admin/offers",1500)}catch(e){console.error("Error deleting offer:",e),window.toast.error("Failed to delete offer")}}window.handleProductScopeChange=v;window.openProductModal=b;window.closeProductModal=_;window.searchProducts=B;window.confirmProductSelection=S;window.clearProductSelection=k;window.removeProduct=P;window.handleSubmit=$;window.deleteOffer=L;document.addEventListener("DOMContentLoaded",()=>{x()});
