const o=parseInt(document.body.dataset.userId);let c=null,f=null,u=[],l=null;async function w(){var t,e;try{if(f=(await axios.get("/api/auth/user")).data,c=(await axios.get(`/api/admin/users/${o}`)).data,c.role==="super_admin"&&f.id!==c.id){document.getElementById("loading").classList.add("hidden"),document.getElementById("permission-denied").classList.remove("hidden");return}I(c),m()}catch(d){console.error("Error loading user:",d),document.getElementById("loading").classList.add("hidden");const s=document.getElementById("error");s.classList.remove("hidden"),s.querySelector("p").textContent=((e=(t=d.response)==null?void 0:t.data)==null?void 0:e.message)||"Failed to load user details"}}function I(t){document.getElementById("loading").classList.add("hidden"),document.getElementById("edit-form-container").classList.remove("hidden"),document.getElementById("phone").value=t.phone,document.getElementById("name").value=t.name||"",document.getElementById("email").value=t.email||"",document.getElementById("role").value=t.role,document.getElementById("is_active").checked=t.is_active}async function m(){try{u=(await axios.get(`/api/admin/users/${o}/addresses`)).data,B()}catch(t){console.error("Error loading addresses:",t),document.getElementById("addresses-list").innerHTML='<p class="text-red-600">Failed to load addresses</p>'}}function B(){const t=document.getElementById("addresses-list");if(u.length===0){t.innerHTML='<p class="text-gray-600">No addresses added yet.</p>';return}t.innerHTML=u.map(e=>`
        <div class="border border-gray-300 rounded-lg p-4 ${e.is_default?"border-green-500 bg-green-50":""}">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                        ${e.is_default?'<span class="px-2 py-1 bg-green-600 text-white text-xs rounded">Default</span>':""}
                    </div>
                    <p class="text-gray-700">${e.address_line_1}</p>
                    ${e.address_line_2?`<p class="text-gray-700">${e.address_line_2}</p>`:""}
                    <p class="text-gray-700">${e.city}, ${e.postcode}</p>
                    <p class="text-gray-700">${e.country||"United Kingdom"}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="window.editAddress(${e.id})" class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick="window.confirmDeleteAddress(${e.id})" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join("")}function h(){l=null,document.getElementById("address-modal-title").textContent="Add Address",document.getElementById("address-form").reset(),document.getElementById("address-country").value="United Kingdom",document.getElementById("address-modal").classList.remove("hidden")}function v(){document.getElementById("address-modal").classList.add("hidden"),l=null}function x(t){const e=u.find(d=>d.id===t);e&&(l=t,document.getElementById("address-modal-title").textContent="Edit Address",document.getElementById("address-line-1").value=e.address_line_1,document.getElementById("address-line-2").value=e.address_line_2||"",document.getElementById("address-city").value=e.city,document.getElementById("address-postcode").value=e.postcode,document.getElementById("address-country").value=e.country||"United Kingdom",document.getElementById("address-is-default").checked=e.is_default,document.getElementById("address-modal").classList.remove("hidden"))}function E(t){window.toast.warning("Click delete again to confirm",3e3);const e=event.target,d=e.innerHTML;e.innerHTML='<i class="fas fa-exclamation-triangle"></i>',e.onclick=()=>_(t),setTimeout(()=>{e.innerHTML=d,e.onclick=()=>E(t)},3e3)}async function _(t){var e,d;try{await axios.delete(`/api/admin/users/${o}/addresses/${t}`),window.toast.success("Address deleted successfully!"),m()}catch(s){console.error("Error deleting address:",s),window.toast.error(((d=(e=s.response)==null?void 0:e.data)==null?void 0:d.message)||"Failed to delete address")}}async function $(){const t=document.getElementById("postcode-search").value.trim(),e=document.getElementById("postcode-results");if(e.innerHTML="",!!t){e.innerHTML='<span class="text-gray-500">Searching...</span>';try{const s=await(await fetch(`https://api.postcodes.io/postcodes/${encodeURIComponent(t)}`)).json();if(s.status!==200||!s.result){e.innerHTML='<span class="text-red-600">No address found for this postcode.</span>';return}const n=s.result,a=n.parliamentary_constituency||n.admin_ward||n.admin_district||n.region||"",r=n.admin_district||n.region||"",i=n.country||"United Kingdom";e.innerHTML=`<button type="button" class="block w-full text-left px-3 py-2 border border-gray-300 rounded-lg hover:bg-blue-50 mb-2" onclick="window.autofillAddressFromPostcode('${n.postcode.replace(/'/g,"")}','${a.replace(/'/g,"")}','${r.replace(/'/g,"")}','${i.replace(/'/g,"")}')">
            ${a?a+", ":""}${r}, ${n.postcode}, ${i}
        </button>`}catch{e.innerHTML='<span class="text-red-600">Failed to fetch address.</span>'}}}function b(t,e,d,s){document.getElementById("address-line-1").value=e,document.getElementById("address-city").value=d,document.getElementById("address-postcode").value=t,document.getElementById("address-country").value=s,document.getElementById("postcode-results").innerHTML=""}document.addEventListener("DOMContentLoaded",()=>{document.getElementById("edit-user-form").addEventListener("submit",async t=>{var d,s;t.preventDefault();const e={name:document.getElementById("name").value,email:document.getElementById("email").value,role:document.getElementById("role").value,is_active:document.getElementById("is_active").checked};try{await axios.patch(`/api/admin/users/${o}`,e),window.toast.success("User updated successfully!"),setTimeout(()=>window.location.href=`/admin/users/${o}`,1e3)}catch(n){console.error("Error updating user:",n),window.toast.error(((s=(d=n.response)==null?void 0:d.data)==null?void 0:s.message)||"Failed to update user")}}),document.getElementById("address-form").addEventListener("submit",async t=>{var d,s,n,a,r,i,g,y;t.preventDefault();const e={user_id:o,address_line_1:((d=document.getElementById("address-line-1"))==null?void 0:d.value)||"",address_line_2:((s=document.getElementById("address-line-2"))==null?void 0:s.value)||"",city:((n=document.getElementById("address-city"))==null?void 0:n.value)||"",postcode:((a=document.getElementById("address-postcode"))==null?void 0:a.value)||"",country:((r=document.getElementById("address-country"))==null?void 0:r.value)||"",is_default:((i=document.getElementById("address-is-default"))==null?void 0:i.checked)||!1};try{l?(await axios.put(`/api/admin/users/${o}/addresses/${l}`,e),window.toast.success("Address updated successfully!")):(await axios.post(`/api/admin/users/${o}/addresses`,e),window.toast.success("Address added successfully!")),v(),m()}catch(p){console.error("Error saving address:",p),window.toast.error(((y=(g=p.response)==null?void 0:g.data)==null?void 0:y.message)||"Failed to save address")}}),w()});window.showAddAddressModal=h;window.closeAddressModal=v;window.editAddress=x;window.confirmDeleteAddress=E;window.searchPostcode=$;window.autofillAddressFromPostcode=b;
